<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“Š ë¶€ì í•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ V3.0</title>
    
    <script src="https://cdn.tailwindcss.com/"></script>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@1.8.5/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .dashboard-container { min-width: 1000px; max-width: 1600px; margin: 0 auto; padding: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 50; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background-color: white; border-radius: 1rem; width: 90%; max-width: 1200px; max-height: 90%; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        
        @media print {
            .no-print { display: none !important; }
            .dashboard-container { min-width: auto; max-width: none; margin: 0; padding: 0; }
        }
        
        .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .heatmap-cell { cursor: pointer; transition: all 0.2s; position: relative; }
        .heatmap-cell:hover { outline: 3px solid #3b82f6; outline-offset: -3px; transform: scale(1.05); z-index: 10; }
        
        .heatmap-table { position: relative; }
        .heatmap-row:hover { background-color: rgba(59, 130, 246, 0.1) !important; }
        .heatmap-col-hover { background-color: rgba(59, 130, 246, 0.1) !important; }
        
        .sticky-header { position: sticky; top: 0; z-index: 20; background: #f9fafb; }
        .sticky-left { position: sticky; left: 0; z-index: 15; background: #f9fafb; }
        .sticky-right { position: sticky; right: 0; z-index: 15; background: #f9fafb; }
        
        .library-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .library-loaded { background-color: #10b981; }
        .library-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useMemo, useState, useCallback } = React;
        const { BarChart, LineChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend, ComposedChart, Line, Area, AreaChart, ScatterChart, Scatter, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Cell } = window.Recharts;

        // ì•„ì´ì½˜
        const Upload = () => <span style={{fontSize: '1.2em'}}>â¬†ï¸</span>;
        const XCircle = () => <span style={{fontSize: '1.2em'}}>âŒ</span>;
        const Search = () => <span style={{fontSize: '1.2em'}}>ğŸ”</span>;
        const CheckSquare = () => <span style={{fontSize: '1.2em'}}>âœ…</span>;
        const Square = () => <span style={{fontSize: '1.2em'}}>â¬œ</span>;
        const Beaker = () => <span style={{fontSize: '1.2em'}}>ğŸ§ª</span>;
        const Download = () => <span style={{fontSize: '1.2em'}}>â¬‡ï¸</span>;
        const Printer = () => <span style={{fontSize: '1.2em'}}>ğŸ–¨ï¸</span>;
        const File = () => <span style={{fontSize: '1.2em'}}>ğŸ“„</span>;
        const TrendingUp = () => <span style={{fontSize: '1.2em'}}>ğŸ“ˆ</span>;
        const Award = () => <span style={{fontSize: '1.2em'}}>ğŸ†</span>;

        const ACCEPT = ".csv,.xlsx,.xls";
        const palette = ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#f97316","#ec4899","#14b8a6","#6d28d9","#be185d","#0ea5e9","#a855f7","#22c55e"];

        const requireExport = (ok, msg = "ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.") => {
            if (!ok) { alert(msg); return false; }
            return true;
        };

        const saveWorkbookAs = (wb, filename) => {
            try {
                XLSX.writeFile(wb, filename);
            } catch (err) {
                console.error(err);
                alert("ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        const getFirstExisting = (row, keys) => {
            for (const k of keys) {
                if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
            }
            return undefined;
        };

        const toYYYYMM = (v) => {
            if (v === undefined || v === null) return "ì•Œìˆ˜ì—†ìŒ";
            const s = String(v).trim();
            if (/^\d{8}$/.test(s)) {
                const y = Number(s.slice(0, 4));
                const mm = Math.max(1, Math.min(12, Number(s.slice(4, 6))));
                return `${y}-${String(mm).padStart(2, "0")}`;
            }
            if (/^\d{6}$/i.test(s)) {
                const y = Number(s.slice(0, 4));
                const mm = Number(s.slice(4, 6));
                if (mm >= 1 && mm <= 12) return `${y}-${String(mm).padStart(2, "0")}`;
            }
            const m1 = s.match(/^(\d{4})[^\d]?(\d{1,2})(?:[^\d]\d{1,2})?$/);
            if (m1) {
                const y = Number(m1[1]);
                const mm = Math.max(1, Math.min(12, Number(m1[2])));
                return `${y}-${String(mm).padStart(2, "0")}`;
            }
            if (/^\d{4,6}$/.test(s)) {
                const num = Number(s);
                if (num >= 20000 && num <= 60000) {
                    const base = new Date(1899, 11, 30);
                    const d = new Date(base.getTime() + num * 86400000);
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, "0");
                    return `${y}-${m}`;
                }
            }
            const m2 = s.match(/(19|20|21)\d{2}[^\d]?(\d{1,2})/);
            if (m2) {
                const y = Number(m2[0].slice(0, 4));
                const mm = Math.max(1, Math.min(12, Number(m2[2])));
                return `${y}-${String(mm).padStart(2, "0")}`;
            }
            return "ì•Œìˆ˜ì—†ìŒ";
        };

        const monthMap = { '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, 'A': 10, 'B': 11, 'C': 12, 'a': 10, 'b': 11, 'c': 12 };

        const serialToProdYYYYMM = (serial) => {
            if (!serial) return "ì•Œìˆ˜ì—†ìŒ";
            const s = String(serial).trim().toUpperCase();
            const m = s.match(/(?:^|[^\d])(\d{2})([1-9A-C])(?:[^\d]|$)/);
            if (!m) return "ì•Œìˆ˜ì—†ìŒ";
            const YY = Number(m[1]);
            const M_char = m[2];
            const MM = monthMap[M_char];
            if (!MM) return "ì•Œìˆ˜ì—†ìŒ";
            const fullY = YY >= 70 ? 1900 + YY : 2000 + YY;
            return `${fullY}-${String(MM).padStart(2, "0")}`;
        };

        const ymToParts = (ym) => {
            if (!ym || ym === "ì•Œìˆ˜ì—†ìŒ") return null;
            const m = ym.match(/^(\d{4})-(\d{2})$/);
            if (!m) return null;
            return { y: Number(m[1]), m: Number(m[2]) };
        };

        const diffMonths = (prodYM, recvYM) => {
            const p = ymToParts(prodYM);
            const r = ymToParts(recvYM);
            if (!p || !r) return null;
            return (r.y - p.y) * 12 + (r.m - p.m);
        };

        const monthCompare = (a, b) => a.localeCompare(b);

        const inMonthRange = (v, start, end) => {
            if (!v || v === "ì•Œìˆ˜ì—†ìŒ") return false;
            const filterStart = start && start.length === 7 ? start : undefined;
            const filterEnd = end && end.length === 7 ? end : undefined;
            if (filterStart && monthCompare(v, filterStart) < 0) return false;
            if (filterEnd && monthCompare(v, filterEnd) > 0) return false;
            return true;
        };

        const getHeatColor = (value, max, colorScheme) => {
            if (value === 0) return '#f3f4f6';
            const ratio = value / max;
            if (colorScheme === 'blue') {
                const intensity = Math.floor(ratio * 200 + 55);
                return `rgb(${255 - intensity}, ${255 - intensity}, 255)`;
            } else if (colorScheme === 'red') {
                const intensity = Math.floor(ratio * 200 + 55);
                return `rgb(255, ${255 - intensity}, ${255 - intensity})`;
            } else {
                const intensity = Math.floor(ratio * 200 + 55);
                return `rgb(${255 - intensity}, 255, ${255 - intensity})`;
            }
        };

        const DEFAULT_COL_ORDER = ["êµ¬ë¶„","ë¶„ë¥˜","ìƒí’ˆì½”ë“œ","ëª¨ë¸","ëª¨ë¸ëª…","ì‹œë¦¬ì–¼","ì ‘ìˆ˜ì¼ì","ì™„ë£Œì¼ì","ì ‘ìˆ˜ë‚´ìš©","ì›ì¸","ì¡°ì¹˜","ì‚¬ìš©ìì¬","ë©”ëª¨ì—¬ë¶€","ìƒì‚°ë…„ì›”","ì ‘ìˆ˜ì›”","ìƒì‚°ì›”","ê³ ê°ëª…","ì—°ë½ì²˜"];

        const orderColumns = (keys) => {
            const set = new Set(keys);
            const ordered = [];
            DEFAULT_COL_ORDER.forEach((k) => { if (set.has(k)) { ordered.push(k); set.delete(k); } });
            ordered.push(...[...set.values()].sort());
            return ordered;
        };

        const Cards = ({ title, value, icon, color = "blue" }) => (
            <div className="rounded-2xl border bg-white shadow-md p-5 flex flex-col gap-2 card-hover">
                <div className="flex items-center justify-between">
                    <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">{title}</div>
                    {icon && <span className="text-2xl">{icon}</span>}
                </div>
                <div className={`text-3xl font-bold text-${color}-600`}>{String(value)}</div>
            </div>
        );

        const CheckboxRow = ({ label, checked, onToggle }) => (
            <button type="button" onClick={onToggle} className="w-full flex items-center gap-2 py-1.5 px-3 rounded hover:bg-gray-100 text-left transition-colors">
                {checked ? <CheckSquare /> : <Square />}
                <span className="text-sm">{label}</span>
            </button>
        );

        const DashboardV3 = () => {
            const [processed, setProcessed] = useState([]);
            const [error, setError] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);
            const [modelQuery, setModelQuery] = useState("");
            const [defectQuery, setDefectQuery] = useState("");
            const [modelSel, setModelSel] = useState({});
            const [defectSel, setDefectSel] = useState({});
            const [recvStart, setRecvStart] = useState("");
            const [recvEnd, setRecvEnd] = useState("");
            const [prodStart, setProdStart] = useState("");
            const [prodEnd, setProdEnd] = useState("");
            const [modalOpen, setModalOpen] = useState(false);
            const [modalRows, setModalRows] = useState([]);
            const [modalTitle, setModalTitle] = useState("");
            const [modalSearch, setModalSearch] = useState("");
            const [modalCols, setModalCols] = useState({});
            const [showColPicker, setShowColPicker] = useState(false);
            const [heatmapColorScheme, setHeatmapColorScheme] = useState('blue');
            const [heatmapSortOrder, setHeatmapSortOrder] = useState('asc');
            const [hoveredRow, setHoveredRow] = useState(null);
            const [hoveredCol, setHoveredCol] = useState(null);
            const [libraryStatus, setLibraryStatus] = useState({
                React: true,
                ReactDOM: true,
                XLSX: typeof XLSX !== 'undefined',
                Recharts: typeof window.Recharts !== 'undefined',
                Babel: true,
                Tailwind: true,
                PropTypes: typeof PropTypes !== 'undefined'
            });

            const onFile = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setError("");
                if (!/\.(csv|xlsx|xls)$/i.test(file.name)) {
                    setError("CSV/XLS/XLSX íŒŒì¼ë§Œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                    return;
                }
                setIsProcessing(true);
                try {
                    const buf = await file.arrayBuffer();
                    const wb = XLSX.read(new Uint8Array(buf), { type: "array" });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                    const rows = json.map((r) => {
                        const model = String(getFirstExisting(r, ["ëª¨ë¸", "ëª¨ë¸ëª…", "ìƒí’ˆì½”ë“œ", "ProductCode", "Model"]) ?? "ì•Œìˆ˜ì—†ìŒ").trim();
                        const defectType = String(getFirstExisting(r, ["ì‚¬ìš©ìì¬", "Material", "ë¶ˆëŸ‰", "ë¶ˆëŸ‰ìœ í˜•", "ì›ì¸", "Defect", "Cause"]) ?? "ì•Œìˆ˜ì—†ìŒ").trim();
                        const repairFinish = getFirstExisting(r, ["ì™„ë£Œì¼ì", "ìˆ˜ë¦¬ì™„ë£Œì¼", "CompleteDate"]);
                        const prodFromCol = getFirstExisting(r, ["ìƒì‚°ë…„ì›”", "ProductionYM", "ìƒì‚°ì›”"]);
                        const serial = getFirstExisting(r, ["ì‹œë¦¬ì–¼", "Serial", "S/N"]);
                        const productionYM = prodFromCol ? toYYYYMM(prodFromCol) : serialToProdYYYYMM(serial);
                        const receiptCol = getFirstExisting(r, ["ì ‘ìˆ˜ì¼ì", "ì ‘ìˆ˜ì›”", "ReceiptDate", "ì ‘ìˆ˜ì¼"]);
                        const receiptYM = toYYYYMM(receiptCol);
                        return { model: model || "ì•Œìˆ˜ì—†ìŒ", defectType: defectType || "ì•Œìˆ˜ì—†ìŒ", productionYM, receiptYM, repairFinish, raw: r };
                    });
                    setProcessed(rows);
                    const mSel = {};
                    const dSel = {};
                    rows.forEach((r) => {
                        if (r.model) mSel[r.model] = true;
                        if (r.defectType) dSel[r.defectType] = true;
                    });
                    setModelSel(mSel);
                    setDefectSel(dSel);
                } catch (e) {
                    console.error(e);
                    setError("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setIsProcessing(false);
                }
            };

            const loadSample = () => {
                const samples = [
                    { model: "GP202T", defectType: "íˆí„°", productionYM: "2024-05", receiptYM: "2025-09", repairFinish: "2025-09-28", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "íˆí„°", ì‹œë¦¬ì–¼: "245XXXXX", ì ‘ìˆ˜ì¼ì: "2025-09-27", ì™„ë£Œì¼ì: "2025-09-28" } },
                    { model: "GP202T", defectType: "ë°”ì´ë©”íƒˆ", productionYM: "2024-06", receiptYM: "2025-09", repairFinish: "2025-09-20", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "ë°”ì´ë©”íƒˆ", ì‹œë¦¬ì–¼: "246XXXXX", ì ‘ìˆ˜ì¼ì: "2025-09-19", ì™„ë£Œì¼ì: "2025-09-20" } },
                    { model: "GP715", defectType: "PCB", productionYM: "2025-01", receiptYM: "2025-03", repairFinish: "2025-03-05", raw: { ëª¨ë¸: "GP715", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "251XXXXX", ì ‘ìˆ˜ì¼ì: "2025-03-02", ì™„ë£Œì¼ì: "" } },
                    { model: "GP106T", defectType: "ì¼€ì´ë¸”", productionYM: "2025-02", receiptYM: "2025-02", repairFinish: "2025-02-15", raw: { ëª¨ë¸: "GP106T", ì‚¬ìš©ìì¬: "ì¼€ì´ë¸”", ì‹œë¦¬ì–¼: "252XXXXX", ì ‘ìˆ˜ì¼ì: "2025-02-14", ì™„ë£Œì¼ì: "2025-02-15" } },
                    { model: "GP202T", defectType: "íˆí„°", productionYM: "2024-05", receiptYM: "2025-09", repairFinish: "2025-09-28", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "íˆí„°", ì‹œë¦¬ì–¼: "245XXXXX", ì ‘ìˆ˜ì¼ì: "2025-09-27", ì™„ë£Œì¼ì: "2025-09-28" } },
                    { model: "GP202T", defectType: "PCB", productionYM: "2024-12", receiptYM: "2025-07", repairFinish: "", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "24CXXXXX", ì ‘ìˆ˜ì¼ì: "2025-07-11", ì™„ë£Œì¼ì: "" } },
                    { model: "GP715", defectType: "PCB", productionYM: "2025-01", receiptYM: "2025-05", repairFinish: "2025-05-19", raw: { ëª¨ë¸: "GP715", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "251XXXXX", ì ‘ìˆ˜ì¼ì: "2025-05-18", ì™„ë£Œì¼ì: "2025-05-19" } },
                    { model: "GP715", defectType: "íˆí„°", productionYM: "2024-10", receiptYM: "2025-05", repairFinish: "2025-05-21", raw: { ëª¨ë¸: "GP715", ì‚¬ìš©ìì¬: "íˆí„°", ì‹œë¦¬ì–¼: "24AXXXXX", ì ‘ìˆ˜ì¼ì: "2025-05-20", ì™„ë£Œì¼ì: "2025-05-21" } },
                    { model: "GP106T", defectType: "ì¼€ì´ë¸”", productionYM: "2025-02", receiptYM: "2025-03", repairFinish: "2025-03-02", raw: { ëª¨ë¸: "GP106T", ì‚¬ìš©ìì¬: "ì¼€ì´ë¸”", ì‹œë¦¬ì–¼: "252XXXXX", ì ‘ìˆ˜ì¼ì: "2025-03-01", ì™„ë£Œì¼ì: "2025-03-02" } },
                    { model: "GP106T", defectType: "PCB", productionYM: "2025-03", receiptYM: "2025-03", repairFinish: "2025-03-12", raw: { ëª¨ë¸: "GP106T", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "253XXXXX", ì ‘ìˆ˜ì¼ì: "2025-03-10", ì™„ë£Œì¼ì: "2025-03-12" } },
                    { model: "GP202T", defectType: "PCB", productionYM: "2024-11", receiptYM: "2025-08", repairFinish: "2025-08-03", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "24BXXXXX", ì ‘ìˆ˜ì¼ì: "2025-08-01", ì™„ë£Œì¼ì: "2025-08-03" } },
                    { model: "GP202T", defectType: "PCB", productionYM: "2024-11", receiptYM: "2025-08", repairFinish: "2025-08-16", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "24BXXXXX", ì ‘ìˆ˜ì¼ì: "2025-08-15", ì™„ë£Œì¼ì: "2025-08-16" } },
                    { model: "GP202T", defectType: "PCB", productionYM: "2024-12", receiptYM: "2025-08", repairFinish: "", raw: { ëª¨ë¸: "GP202T", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "24CXXXXX", ì ‘ìˆ˜ì¼ì: "2025-08-28", ì™„ë£Œì¼ì: "" } },
                    { model: "GP715", defectType: "PCB", productionYM: "2025-02", receiptYM: "2025-04", repairFinish: "2025-04-12", raw: { ëª¨ë¸: "GP715", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "252XXXXX", ì ‘ìˆ˜ì¼ì: "2025-04-10", ì™„ë£Œì¼ì: "2025-04-12" } },
                    { model: "GP715", defectType: "PCB", productionYM: "2025-02", receiptYM: "2025-05", repairFinish: "2025-05-08", raw: { ëª¨ë¸: "GP715", ì‚¬ìš©ìì¬: "PCB", ì‹œë¦¬ì–¼: "252XXXXX", ì ‘ìˆ˜ì¼ì: "2025-05-05", ì™„ë£Œì¼ì: "2025-05-08" } },
                ];
                setProcessed(samples);
                const mSel = {};
                const dSel = {};
                samples.forEach((r) => { mSel[r.model] = true; dSel[r.defectType] = true; });
                setModelSel(mSel);
                setDefectSel(dSel);
            };

            const openModal = (title, rows) => {
                const rawRows = rows.map((r) => r.raw || r);
                setModalTitle(title);
                setModalRows(rawRows);
                const keys = Array.from(new Set(rawRows.flatMap((r) => Object.keys(r))));
                const ordered = orderColumns(keys);
                const initSel = {};
                ordered.forEach((k) => (initSel[k] = true));
                setModalCols(initSel);
                setModalSearch("");
                setShowColPicker(false);
                setModalOpen(true);
            };

            const modelOptions = useMemo(() => {
                const s = new Set();
                processed.forEach((r) => s.add(r.model || "ì•Œìˆ˜ì—†ìŒ"));
                return [...s].sort();
            }, [processed]);

            const defectOptions = useMemo(() => {
                const s = new Set();
                processed.forEach((r) => s.add(r.defectType || "ì•Œìˆ˜ì—†ìŒ"));
                return [...s].sort();
            }, [processed]);

            const filtered = useMemo(() => {
                const mq = modelQuery.toLowerCase();
                const dq = defectQuery.toLowerCase();
                const activeModels = new Set(Object.keys(modelSel).filter((k) => modelSel[k]));
                const activeDef = new Set(Object.keys(defectSel).filter((k) => defectSel[k]));
                return processed.filter((r) => {
                    const mPass = activeModels.size ? activeModels.has(r.model) : true;
                    const dPass = activeDef.size ? activeDef.has(r.defectType) : true;
                    const mSearch = mq ? String(r.model).toLowerCase().includes(mq) : true;
                    const dSearch = dq ? String(r.defectType).toLowerCase().includes(dq) : true;
                    const recvPass = (recvStart || recvEnd) ? inMonthRange(r.receiptYM, recvStart || undefined, recvEnd || undefined) : true;
                    const prodPass = (prodStart || prodEnd) ? inMonthRange(r.productionYM, prodStart || undefined, prodEnd || undefined) : true;
                    return mPass && dPass && mSearch && dSearch && recvPass && prodPass;
                });
            }, [processed, modelSel, defectSel, modelQuery, defectQuery, recvStart, recvEnd, prodStart, prodEnd]);

            // KPI
            const kpi = useMemo(() => {
                const total = filtered.length;
                const uniqueModels = new Set(filtered.map(r => r.model).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ")).size;
                const uniqueDefects = new Set(filtered.map(r => r.defectType).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ")).size;
                
                const usageValues = filtered.map(r => diffMonths(r.productionYM, r.receiptYM)).filter(u => u !== null && u >= 0).sort((a, b) => a - b);
                const medianUsage = usageValues.length > 0 ? usageValues[Math.floor(usageValues.length / 2)] : 0;
                
                const defectMap = new Map();
                filtered.forEach(r => {
                    if (r.defectType !== "ì•Œìˆ˜ì—†ìŒ") {
                        defectMap.set(r.defectType, (defectMap.get(r.defectType) || 0) + 1);
                    }
                });
                const top3Defects = [...defectMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 3).map(([name, count]) => ({
                    name, count, ratio: total > 0 ? ((count / total) * 100).toFixed(1) : 0
                }));

                const modelMap = new Map();
                filtered.forEach(r => {
                    if (r.model !== "ì•Œìˆ˜ì—†ìŒ") {
                        modelMap.set(r.model, (modelMap.get(r.model) || 0) + 1);
                    }
                });
                const top3Models = [...modelMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 3).map(([name, count]) => ({
                    name, count, ratio: total > 0 ? ((count / total) * 100).toFixed(1) : 0
                }));

                return { total, uniqueModels, uniqueDefects, medianUsage, top3Defects, top3Models };
            }, [filtered]);

            // ì°¨íŠ¸ ë°ì´í„°
            const timeSeriesStacked = useMemo(() => {
                if (!filtered.length) return { data: [], keys: [] };
                const byDef = new Map();
                filtered.forEach((r) => byDef.set(r.defectType, (byDef.get(r.defectType) || 0) + 1));
                const top10 = [...byDef.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10).map((x) => x[0]);
                const months = [...new Set(filtered.map((r) => r.receiptYM))].sort(monthCompare);
                const rows = months.map((m) => {
                    const obj = { month: m, total: 0 };
                    let otherCount = 0;
                    filtered.filter((r) => r.receiptYM === m).forEach((r) => {
                        obj.total += 1;
                        if (top10.includes(r.defectType)) {
                            obj[r.defectType] = (obj[r.defectType] || 0) + 1;
                        } else {
                            otherCount += 1;
                        }
                    });
                    obj["ê¸°íƒ€"] = otherCount;
                    return obj;
                });
                const keys = [...top10, "ê¸°íƒ€"].filter(k => k !== 'ì•Œìˆ˜ì—†ìŒ');
                return { data: rows.filter(r => r.month !== 'ì•Œìˆ˜ì—†ìŒ'), keys };
            }, [filtered]);

            const materialRate = useMemo(() => {
                const total = filtered.length || 1;
                const map = new Map();
                filtered.forEach((r) => map.set(r.defectType, (map.get(r.defectType) || 0) + 1));
                return [...map.entries()].sort((a, b) => b[1] - a[1]).map(([name, cnt]) => ({ name, count: cnt, ratio: Number((cnt / total).toFixed(4)) }));
            }, [filtered]);

            const materialRateCumulative = useMemo(() => {
                let cumulativeCount = 0;
                const total = filtered.length || 1;
                return materialRate.map(r => {
                    cumulativeCount += r.count;
                    return { ...r, cumulativeCount, cumulativeRatio: cumulativeCount / total };
                });
            }, [materialRate, filtered.length]);

            const heatmapProdRecv = useMemo(() => {
                const matrix = new Map();
                filtered.forEach(r => {
                    if (r.productionYM !== "ì•Œìˆ˜ì—†ìŒ" && r.receiptYM !== "ì•Œìˆ˜ì—†ìŒ") {
                        const key = `${r.productionYM}|${r.receiptYM}`;
                        matrix.set(key, (matrix.get(key) || 0) + 1);
                    }
                });
                let prodMonths = [...new Set(filtered.map(r => r.productionYM).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ"))].sort();
                let recvMonths = [...new Set(filtered.map(r => r.receiptYM).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ"))].sort();
                
                if (heatmapSortOrder === 'desc') {
                    prodMonths = prodMonths.reverse();
                    recvMonths = recvMonths.reverse();
                }
                
                const maxValue = Math.max(...matrix.values(), 1);
                return { matrix, prodMonths, recvMonths, maxValue };
            }, [filtered, heatmapSortOrder]);

            const heatmapProdUsage = useMemo(() => {
                const matrix = new Map();
                filtered.forEach(r => {
                    const usage = diffMonths(r.productionYM, r.receiptYM);
                    if (usage !== null && usage >= 0 && r.productionYM !== "ì•Œìˆ˜ì—†ìŒ") {
                        const key = `${r.productionYM}|${usage}`;
                        matrix.set(key, (matrix.get(key) || 0) + 1);
                    }
                });
                let prodMonths = [...new Set(filtered.map(r => r.productionYM).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ"))].sort();
                const usageBins = [...new Set([...matrix.keys()].map(k => parseInt(k.split('|')[1])))].sort((a, b) => a - b);
                
                if (heatmapSortOrder === 'desc') {
                    prodMonths = prodMonths.reverse();
                }
                
                const maxValue = Math.max(...matrix.values(), 1);
                return { matrix, prodMonths, usageBins, maxValue };
            }, [filtered, heatmapSortOrder]);

            const mtbfData = useMemo(() => {
                const modelUsage = new Map();
                filtered.forEach(r => {
                    const usage = diffMonths(r.productionYM, r.receiptYM);
                    if (usage !== null && usage >= 0 && r.model !== "ì•Œìˆ˜ì—†ìŒ") {
                        if (!modelUsage.has(r.model)) modelUsage.set(r.model, []);
                        modelUsage.get(r.model).push(usage);
                    }
                });
                const mtbf = [];
                modelUsage.forEach((usages, model) => {
                    const avg = usages.reduce((sum, u) => sum + u, 0) / usages.length;
                    mtbf.push({ model, mtbf: parseFloat(avg.toFixed(1)), count: usages.length });
                });
                return mtbf.sort((a, b) => b.mtbf - a.mtbf).slice(0, 10);
            }, [filtered]);

            const radarData = useMemo(() => {
                const modelDefects = new Map();
                filtered.forEach(r => {
                    if (r.model !== "ì•Œìˆ˜ì—†ìŒ" && r.defectType !== "ì•Œìˆ˜ì—†ìŒ") {
                        if (!modelDefects.has(r.model)) modelDefects.set(r.model, new Map());
                        const defMap = modelDefects.get(r.model);
                        defMap.set(r.defectType, (defMap.get(r.defectType) || 0) + 1);
                    }
                });
                const topModels = [...modelDefects.entries()].sort((a, b) => {
                    const aTotal = [...a[1].values()].reduce((sum, v) => sum + v, 0);
                    const bTotal = [...b[1].values()].reduce((sum, v) => sum + v, 0);
                    return bTotal - aTotal;
                }).slice(0, 5);
                
                const allDefects = new Set();
                topModels.forEach(([_, defMap]) => {
                    defMap.forEach((_, def) => allDefects.add(def));
                });
                
                return [...allDefects].map(defect => {
                    const point = { defect };
                    topModels.forEach(([model, defMap]) => {
                        point[model] = defMap.get(defect) || 0;
                    });
                    return point;
                });
            }, [filtered]);

            const yearlyTrend = useMemo(() => {
                const yearMap = new Map();
                filtered.forEach(r => {
                    const parts = ymToParts(r.receiptYM);
                    if (parts) {
                        yearMap.set(parts.y, (yearMap.get(parts.y) || 0) + 1);
                    }
                });
                return [...yearMap.entries()].sort((a, b) => a[0] - b[0]).map(([year, count]) => ({ year: String(year), count }));
            }, [filtered]);

            // ì‚°ì ë„ ë°ì´í„°
            const scatterData = useMemo(() => {
                const materialGroups = new Map();
                filtered.forEach(r => {
                    const usage = diffMonths(r.productionYM, r.receiptYM);
                    if (usage !== null && usage >= 0 && r.defectType !== "ì•Œìˆ˜ì—†ìŒ") {
                        if (!materialGroups.has(r.defectType)) {
                            materialGroups.set(r.defectType, []);
                        }
                        materialGroups.get(r.defectType).push(usage);
                    }
                });
                
                const result = [];
                materialGroups.forEach((usages, material) => {
                    usages.forEach((usage, idx) => {
                        result.push({
                            x: usage,
                            y: usages.length,
                            material,
                            count: usages.length
                        });
                    });
                });
                return result;
            }, [filtered]);

            // ë²„ë¸”ì°¨íŠ¸ ë°ì´í„°
            const bubbleData = useMemo(() => {
                const modelStats = new Map();
                const total = filtered.length || 1;
                
                filtered.forEach(r => {
                    if (r.model !== "ì•Œìˆ˜ì—†ìŒ") {
                        if (!modelStats.has(r.model)) {
                            modelStats.set(r.model, { count: 0, usages: [] });
                        }
                        const stats = modelStats.get(r.model);
                        stats.count += 1;
                        const usage = diffMonths(r.productionYM, r.receiptYM);
                        if (usage !== null && usage >= 0) stats.usages.push(usage);
                    }
                });
                
                return [...modelStats.entries()]
                    .map(([model, stats]) => ({
                        model,
                        x: stats.usages.length > 0 ? stats.usages.reduce((a, b) => a + b, 0) / stats.usages.length : 0,
                        y: stats.count,
                        z: ((stats.count / total) * 100).toFixed(1),
                        ratio: ((stats.count / total) * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.y - a.y)
                    .slice(0, 20);
            }, [filtered]);

            // íŠ¸ë¦¬ë§µ ë°ì´í„°
            const treemapData = useMemo(() => {
                const map = new Map();
                filtered.forEach(r => {
                    if (r.model !== "ì•Œìˆ˜ì—†ìŒ" && r.defectType !== "ì•Œìˆ˜ì—†ìŒ") {
                        const key = `${r.model}|${r.defectType}`;
                        map.set(key, (map.get(key) || 0) + 1);
                    }
                });
                
                const children = [];
                map.forEach((count, key) => {
                    const [model, defect] = key.split('|');
                    children.push({
                        name: `${model}\n${defect}`,
                        size: count,
                        model,
                        defect
                    });
                });
                
                return [{
                    name: "ì „ì²´",
                    children: children.sort((a, b) => b.size - a.size).slice(0, 30)
                }];
            }, [filtered]);

            // ë°•ìŠ¤í”Œë¡¯ ë°ì´í„°
            const boxPlotData = useMemo(() => {
                const usageValues = filtered
                    .map(r => diffMonths(r.productionYM, r.receiptYM))
                    .filter(u => u !== null && u >= 0)
                    .sort((a, b) => a - b);
                
                if (usageValues.length === 0) return null;
                
                const getQuantile = (arr, p) => {
                    const index = p * (arr.length - 1);
                    const i = Math.floor(index);
                    const f = index - i;
                    if (i === arr.length - 1) return arr[arr.length - 1];
                    return arr[i] + f * (arr[i + 1] - arr[i]);
                };
                
                const q1 = getQuantile(usageValues, 0.25);
                const median = getQuantile(usageValues, 0.5);
                const q3 = getQuantile(usageValues, 0.75);
                const iqr = q3 - q1;
                const min = Math.max(usageValues[0], q1 - 1.5 * iqr);
                const max = Math.min(usageValues[usageValues.length - 1], q3 + 1.5 * iqr);
                
                return [{
                    name: 'ì‚¬ìš©ê¸°ê°„',
                    min: min.toFixed(1),
                    q1: q1.toFixed(1),
                    median: median.toFixed(1),
                    q3: q3.toFixed(1),
                    max: max.toFixed(1),
                    avg: (usageValues.reduce((a, b) => a + b, 0) / usageValues.length).toFixed(1)
                }];
            }, [filtered]);

            // ì˜ˆì¸¡ ë°ì´í„° (3ê°œì›” ì´ë™í‰ê· )
            const forecastData = useMemo(() => {
                const monthlyCount = new Map();
                filtered.forEach(r => {
                    if (r.receiptYM !== "ì•Œìˆ˜ì—†ìŒ") {
                        monthlyCount.set(r.receiptYM, (monthlyCount.get(r.receiptYM) || 0) + 1);
                    }
                });
                
                const sorted = [...monthlyCount.entries()].sort((a, b) => monthCompare(a[0], b[0]));
                const data = sorted.map(([month, count]) => ({ month, actual: count }));
                
                // 3ê°œì›” ì´ë™í‰ê·  ê³„ì‚°
                const result = data.map((item, idx) => {
                    if (idx >= 2) {
                        const ma3 = (data[idx].actual + data[idx-1].actual + data[idx-2].actual) / 3;
                        return { ...item, ma3: parseFloat(ma3.toFixed(1)) };
                    }
                    return { ...item, ma3: null };
                });
                
                // ë‹¤ìŒ ë‹¬ ì˜ˆì¸¡
                if (result.length >= 3) {
                    const lastMA = result[result.length - 1].ma3;
                    const lastMonth = result[result.length - 1].month;
                    const parts = ymToParts(lastMonth);
                    
                    if (parts && lastMA) {
                        const nextMonth = parts.m === 12 
                            ? `${parts.y + 1}-01` 
                            : `${parts.y}-${String(parts.m + 1).padStart(2, '0')}`;
                        
                        result.push({
                            month: nextMonth,
                            actual: null,
                            ma3: lastMA,
                            forecast: true
                        });
                    }
                }
                
                return result;
            }, [filtered]);

            // ë°”ì´ì˜¬ë¦° í”Œë¡¯ (íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ëŒ€ì²´)
            const violinData = useMemo(() => {
                const usageValues = filtered.map(r => diffMonths(r.productionYM, r.receiptYM)).filter(u => u !== null && u >= 0);
                const bins = {};
                usageValues.forEach(u => {
                    const bin = Math.floor(u / 3) * 3;
                    bins[bin] = (bins[bin] || 0) + 1;
                });
                return Object.entries(bins).map(([range, count]) => ({
                    range: `${range}-${parseInt(range) + 2}ê°œì›”`,
                    rangeValue: parseInt(range),
                    count
                })).sort((a, b) => a.rangeValue - b.rangeValue);
            }, [filtered]);

            // ì›Œí„°í´ ì°¨íŠ¸ ë°ì´í„°
            const waterfallData = useMemo(() => {
                const monthlyCount = new Map();
                filtered.forEach(r => {
                    if (r.receiptYM !== "ì•Œìˆ˜ì—†ìŒ") {
                        monthlyCount.set(r.receiptYM, (monthlyCount.get(r.receiptYM) || 0) + 1);
                    }
                });
                
                const sorted = [...monthlyCount.entries()].sort((a, b) => monthCompare(a[0], b[0]));
                let cumulative = 0;
                return sorted.map(([month, count]) => {
                    const start = cumulative;
                    cumulative += count;
                    return { month, count, start, end: cumulative };
                });
            }, [filtered]);

            // êµ¬ë¶„ë³„ ë¹„êµ (ê³ ê°ìœ í˜• ë“±)
            const categoryData = useMemo(() => {
                const categoryMap = new Map();
                const total = filtered.length || 1;
                
                filtered.forEach(r => {
                    const category = getFirstExisting(r.raw, ["êµ¬ë¶„", "ê³ ê°ìœ í˜•", "ìœ í˜•", "Category"]) || "ë¯¸ë¶„ë¥˜";
                    categoryMap.set(category, (categoryMap.get(category) || 0) + 1);
                });
                
                return [...categoryMap.entries()]
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => ({
                        name,
                        count,
                        ratio: ((count / total) * 100).toFixed(1)
                    }));
            }, [filtered]);

            // í¼ë„ ì°¨íŠ¸ ë°ì´í„° (ì²˜ë¦¬ ë‹¨ê³„ë³„)
            const funnelData = useMemo(() => {
                const total = filtered.length;
                const completed = filtered.filter(r => r.repairFinish && String(r.repairFinish).trim() !== "").length;
                const pending = total - completed;
                
                const materials = new Set(filtered.map(r => r.defectType).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ")).size;
                const models = new Set(filtered.map(r => r.model).filter(x => x !== "ì•Œìˆ˜ì—†ìŒ")).size;
                
                return [
                    { stage: "ì ‘ìˆ˜", count: total, ratio: 100 },
                    { stage: "ë¶„ì„ ì¤‘", count: pending, ratio: ((pending / total) * 100).toFixed(1) },
                    { stage: "ìˆ˜ë¦¬ ì™„ë£Œ", count: completed, ratio: ((completed / total) * 100).toFixed(1) },
                    { stage: "ëª¨ë¸ ì¢…ë¥˜", count: models, ratio: ((models / total) * 100).toFixed(1) },
                    { stage: "ì‚¬ìš©ìì¬ ì¢…ë¥˜", count: materials, ratio: ((materials / total) * 100).toFixed(1) }
                ];
            }, [filtered]);

            // ì „ë…„ë™ì›” ë¹„êµ
            const yoyCompare = useMemo(() => {
                const monthlyByYear = new Map();
                
                filtered.forEach(r => {
                    const parts = ymToParts(r.receiptYM);
                    if (parts) {
                        const key = `${parts.y}-${parts.m}`;
                        if (!monthlyByYear.has(key)) {
                            monthlyByYear.set(key, { year: parts.y, month: parts.m, count: 0 });
                        }
                        monthlyByYear.get(key).count += 1;
                    }
                });
                
                const data = [...monthlyByYear.values()].sort((a, b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return a.month - b.month;
                });
                
                // ê° ì›”ë³„ë¡œ ì „ë…„ ëŒ€ë¹„ ê³„ì‚°
                const result = data.map(item => {
                    const prevYear = data.find(d => d.year === item.year - 1 && d.month === item.month);
                    const growth = prevYear ? ((item.count - prevYear.count) / prevYear.count * 100).toFixed(1) : null;
                    return {
                        period: `${item.year}-${String(item.month).padStart(2, '0')}`,
                        current: item.count,
                        previous: prevYear?.count || 0,
                        growth
                    };
                });
                
                return result.slice(-12); // ìµœê·¼ 12ê°œì›”
            }, [filtered]);

            // ì›”ë³„ ì„¸ë¶„í™” (ì—°ë„ë³„ ë¶„ë¦¬)
            const monthlyByYear = useMemo(() => {
                const yearData = new Map();
                
                filtered.forEach(r => {
                    const parts = ymToParts(r.receiptYM);
                    if (parts) {
                        if (!yearData.has(parts.y)) {
                            yearData.set(parts.y, new Map());
                        }
                        const monthMap = yearData.get(parts.y);
                        monthMap.set(parts.m, (monthMap.get(parts.m) || 0) + 1);
                    }
                });
                
                const years = [...yearData.keys()].sort();
                const months = Array.from({length: 12}, (_, i) => i + 1);
                
                return months.map(m => {
                    const row = { month: `${m}ì›”` };
                    years.forEach(y => {
                        row[`${y}ë…„`] = yearData.get(y)?.get(m) || 0;
                    });
                    return row;
                });
            }, [filtered]);

            const makeToggleModel = useCallback((m) => () => setModelSel((prev) => ({ ...prev, [m]: !prev[m] })), []);
            const makeToggleDefect = useCallback((d) => () => setDefectSel((prev) => ({ ...prev, [d]: !prev[d] })), []);

            const toggleAll = (type, state) => {
                if (type === "model") {
                    const newSel = {};
                    modelOptions.forEach((m) => (newSel[m] = state));
                    setModelSel(newSel);
                } else if (type === "defect") {
                    const newSel = {};
                    defectOptions.forEach((d) => (newSel[d] = state));
                    setDefectSel(newSel);
                }
            };

            const exportChartData = (data, filename) => {
                if (!requireExport(data && data.length > 0)) return;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "ë°ì´í„°");
                saveWorkbookAs(wb, filename);
            };

            const exportAllSummary = useCallback(() => {
                if (!requireExport(filtered.length > 0)) return;
                const wb = XLSX.utils.book_new();
                
                // 1. KPI
                const kpiData = [
                    { í•­ëª©: "ì´ ë¶ˆëŸ‰ ê±´ìˆ˜", ê°’: kpi.total },
                    { í•­ëª©: "ì´ ëª¨ë¸ ìˆ˜", ê°’: kpi.uniqueModels },
                    { í•­ëª©: "ì´ ì‚¬ìš©ìì¬ ìˆ˜", ê°’: kpi.uniqueDefects },
                    { í•­ëª©: "ì¤‘ì•™ê°’ ì‚¬ìš©ê¸°ê°„", ê°’: kpi.medianUsage + "ê°œì›”" },
                ];
                kpi.top3Models.forEach((m, idx) => {
                    kpiData.push({ í•­ëª©: `TOP ${idx+1} ëª¨ë¸`, ê°’: `${m.name} (${m.count}ê±´, ${m.ratio}%)` });
                });
                kpi.top3Defects.forEach((d, idx) => {
                    kpiData.push({ í•­ëª©: `TOP ${idx+1} ì‚¬ìš©ìì¬`, ê°’: `${d.name} (${d.count}ê±´, ${d.ratio}%)` });
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kpiData), "KPI");
                
                // 2. ì›”ë³„ì¶”ì´
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(timeSeriesStacked.data), "ì›”ë³„ì¶”ì´");
                
                // 3. íŒŒë ˆí† 
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(materialRateCumulative), "íŒŒë ˆí† ");
                
                // 4. ì½”í˜¸íŠ¸ íˆíŠ¸ë§µ
                const cohortData = [];
                heatmapProdRecv.prodMonths.forEach(pm => {
                    const row = { ìƒì‚°ì›”: pm };
                    heatmapProdRecv.recvMonths.forEach(rm => {
                        row[rm] = heatmapProdRecv.matrix.get(`${pm}|${rm}`) || 0;
                    });
                    cohortData.push(row);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cohortData), "ì½”í˜¸íŠ¸");
                
                // 5. ì‚¬ìš©ê¸°ê°„ íˆíŠ¸ë§µ
                const usageData = [];
                heatmapProdUsage.prodMonths.forEach(pm => {
                    const row = { ìƒì‚°ì›”: pm };
                    heatmapProdUsage.usageBins.forEach(ub => {
                        row[`${ub}ê°œì›”`] = heatmapProdUsage.matrix.get(`${pm}|${ub}`) || 0;
                    });
                    usageData.push(row);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(usageData), "ì‚¬ìš©ê¸°ê°„");
                
                // 6. MTBF
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mtbfData), "MTBF");
                
                // 7. ë ˆì´ë”
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(radarData), "ë ˆì´ë”");
                
                // 8. ì—°ë„ë³„
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(yearlyTrend), "ì—°ë„ë³„");
                
                // 9. ì‚°ì ë„
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(scatterData), "ì‚°ì ë„");
                
                // 10. ë²„ë¸”ì°¨íŠ¸
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(bubbleData), "ë²„ë¸”ì°¨íŠ¸");
                
                // 11. ë°•ìŠ¤í”Œë¡¯
                if (boxPlotData) {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(boxPlotData), "ë°•ìŠ¤í”Œë¡¯");
                }
                
                // 12. ì˜ˆì¸¡
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(forecastData), "ì˜ˆì¸¡");
                
                // 13. ëª¨ë¸ë³„
                const modelCount = new Map();
                const total = filtered.length || 1;
                filtered.forEach(r => {
                    if (r.model !== "ì•Œìˆ˜ì—†ìŒ") {
                        modelCount.set(r.model, (modelCount.get(r.model) || 0) + 1);
                    }
                });
                const modelData = [...modelCount.entries()].sort((a, b) => b[1] - a[1]).map(([model, count]) => ({
                    ëª¨ë¸: model,
                    ê±´ìˆ˜: count,
                    ë¹„ìœ¨: ((count / total) * 100).toFixed(2) + '%'
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(modelData), "ëª¨ë¸ë³„");
                
                // 14. ì‚¬ìš©ìì¬ë³„
                const materialData = materialRateCumulative.map(r => ({
                    ì‚¬ìš©ìì¬: r.name,
                    ê±´ìˆ˜: r.count,
                    ë¹„ìœ¨: (r.ratio * 100).toFixed(2) + '%',
                    ëˆ„ì ë¹„ìœ¨: (r.cumulativeRatio * 100).toFixed(2) + '%'
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(materialData), "ì‚¬ìš©ìì¬ë³„");
                
                // 15-20. ì¶”ê°€ ì°¨íŠ¸
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(violinData), "ë°€ë„ë¶„í¬");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(waterfallData), "ì›Œí„°í´");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(categoryData), "êµ¬ë¶„ë³„");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(funnelData), "í¼ë„");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(yoyCompare), "ì „ë…„ë™ì›”");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(monthlyByYear), "ì›”ë³„ì—°ë„");
                
                // ì›ë³¸ ë°ì´í„°
                const rawRows = filtered.map(r => r.raw);
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rawRows), "ì›ë³¸ë°ì´í„°");
                
                saveWorkbookAs(wb, "ë¶€ì í•©ë¶„ì„_ì „ì²´ë³´ê³ ì„œ.xlsx");
            }, [filtered, kpi, timeSeriesStacked, materialRateCumulative, heatmapProdRecv, heatmapProdUsage, mtbfData, radarData, yearlyTrend, scatterData, bubbleData, boxPlotData, forecastData, violinData, waterfallData, categoryData, funnelData, yoyCompare, monthlyByYear]);

            return (
                <div className="dashboard-container">
                    <header className="gradient-bg py-6 px-8 rounded-3xl mb-8 shadow-2xl no-print">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-4xl font-bold text-white mb-2">ğŸ“Š ë¶€ì í•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ V3.0</h1>
                                <p className="text-blue-100">ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ë° ì˜ˆì¸¡ ì‹œìŠ¤í…œ - ê°•ìƒí˜„</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm transition-all">
                                    <Printer /> ì¸ì‡„
                                </button>
                                <button onClick={exportAllSummary} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-orange-500 hover:bg-orange-600 text-white shadow-lg transition-all">
                                    <File /> ì „ì²´ ë³´ê³ ì„œ
                                </button>
                                <label className="flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-500 hover:bg-blue-600 text-white shadow-lg cursor-pointer transition-all">
                                    <Upload /> ì—…ë¡œë“œ
                                    <input type="file" accept={ACCEPT} onChange={onFile} className="hidden" />
                                </label>
                            </div>
                        </div>
                    </header>

                    <div className="mb-8 no-print">
                        <div className="rounded-2xl border bg-white shadow-md p-6">
                            <div className="flex items-center justify-between">
                                <div className="flex gap-8">
                                    <div>
                                        <div className="text-sm text-gray-500 mb-1">ì´ ë°ì´í„°</div>
                                        <div className="text-3xl font-bold text-gray-800">{processed.length} ê±´</div>
                                    </div>
                                    <div className="border-l pl-8">
                                        <div className="text-sm text-gray-500 mb-1">í•„í„°ë§ í›„</div>
                                        <div className="text-3xl font-bold text-blue-600">{filtered.length} ê±´</div>
                                    </div>
                                </div>
                                {isProcessing && (
                                    <div className="flex items-center gap-3">
                                        <div className="spinner"></div>
                                        <span className="text-blue-600 font-medium">ì²˜ë¦¬ ì¤‘...</span>
                                    </div>
                                )}
                                {error && (
                                    <div className="flex items-center gap-2 text-red-600">
                                        <XCircle /> <span>{error}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {filtered.length > 0 && (
                        <>
                            <div className="mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                                <Cards title="ì´ ë¶ˆëŸ‰ ê±´ìˆ˜" value={kpi.total} icon="ğŸ“¦" color="blue" />
                                <Cards title="ì´ ëª¨ë¸ ìˆ˜" value={kpi.uniqueModels} icon="ğŸ”§" color="green" />
                                <Cards title="ì´ ì‚¬ìš©ìì¬ ìˆ˜" value={kpi.uniqueDefects} icon="âš ï¸" color="orange" />
                                <Cards title="ì´ˆê¸° ë¶ˆëŸ‰ ì¤‘ì•™ê°’" value={`${kpi.medianUsage}ê°œì›”`} icon="â±ï¸" color="purple" />
                                <div className="rounded-2xl border bg-white shadow-md p-5 card-hover">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">TOP 3 ë¶ˆëŸ‰ ëª¨ë¸</div>
                                        <Award />
                                    </div>
                                    <div className="space-y-1">
                                        {kpi.top3Models.map((item, idx) => (
                                            <div key={idx} className="flex justify-between text-xs">
                                                <span className="font-medium text-gray-700">{idx + 1}. {item.name}</span>
                                                <span className="text-blue-600 font-bold">{item.ratio}%</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="rounded-2xl border bg-white shadow-md p-5 card-hover">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">TOP 3 ì‚¬ìš©ìì¬</div>
                                        <Award />
                                    </div>
                                    <div className="space-y-1">
                                        {kpi.top3Defects.map((item, idx) => (
                                            <div key={idx} className="flex justify-between text-xs">
                                                <span className="font-medium text-gray-700">{idx + 1}. {item.name}</span>
                                                <span className="text-red-600 font-bold">{item.ratio}%</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="mb-8 grid grid-cols-1 lg:grid-cols-3 gap-6 no-print">
                                <div className="rounded-2xl border bg-white shadow-md p-5">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="font-bold text-lg">ëª¨ë¸ í•„í„°</div>
                                        <div className="flex gap-2">
                                            <button className="px-3 py-1 rounded-lg border text-xs hover:bg-gray-50 transition-colors" onClick={() => toggleAll("model", true)}>ì „ì²´</button>
                                            <button className="px-3 py-1 rounded-lg border text-xs hover:bg-gray-50 transition-colors" onClick={() => toggleAll("model", false)}>í•´ì œ</button>
                                        </div>
                                    </div>
                                    <div className="relative mb-3">
                                        <input type="text" placeholder="ëª¨ë¸ëª… ê²€ìƒ‰" value={modelQuery} onChange={(e) => setModelQuery(e.target.value)} className="w-full pl-3 pr-3 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 transition-all" />
                                    </div>
                                    <div className="h-48 overflow-auto border rounded-xl">
                                        {modelOptions.filter((m) => (modelQuery ? m.toLowerCase().includes(modelQuery.toLowerCase()) : true)).map((m) => (
                                            <CheckboxRow key={m} label={m} checked={!!modelSel[m]} onToggle={makeToggleModel(m)} />
                                        ))}
                                    </div>
                                </div>

                                <div className="rounded-2xl border bg-white shadow-md p-5">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="font-bold text-lg">ì‚¬ìš©ìì¬ í•„í„°</div>
                                        <div className="flex gap-2">
                                            <button className="px-3 py-1 rounded-lg border text-xs hover:bg-gray-50 transition-colors" onClick={() => toggleAll("defect", true)}>ì „ì²´</button>
                                            <button className="px-3 py-1 rounded-lg border text-xs hover:bg-gray-50 transition-colors" onClick={() => toggleAll("defect", false)}>í•´ì œ</button>
                                        </div>
                                    </div>
                                    <div className="relative mb-3">
                                        <input type="text" placeholder="ì‚¬ìš©ìì¬ ê²€ìƒ‰" value={defectQuery} onChange={(e) => setDefectQuery(e.target.value)} className="w-full pl-3 pr-3 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 transition-all" />
                                    </div>
                                    <div className="h-48 overflow-auto border rounded-xl">
                                        {defectOptions.filter((d) => (defectQuery ? d.toLowerCase().includes(defectQuery.toLowerCase()) : true)).map((d) => (
                                            <CheckboxRow key={d} label={d} checked={!!defectSel[d]} onToggle={makeToggleDefect(d)} />
                                        ))}
                                    </div>
                                </div>

                                <div className="rounded-2xl border bg-white shadow-md p-5">
                                    <div className="font-bold text-lg mb-3">ê¸°ê°„ í•„í„°</div>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">ì ‘ìˆ˜ì›”</label>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="month" 
                                                    value={recvStart} 
                                                    onChange={(e) => setRecvStart(e.target.value)} 
                                                    className="w-1/2 border rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" 
                                                />
                                                <input 
                                                    type="month" 
                                                    value={recvEnd} 
                                                    onChange={(e) => setRecvEnd(e.target.value)} 
                                                    className="w-1/2 border rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" 
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">ìƒì‚°ì›”</label>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="month" 
                                                    value={prodStart} 
                                                    onChange={(e) => setProdStart(e.target.value)} 
                                                    className="w-1/2 border rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" 
                                                />
                                                <input 
                                                    type="month" 
                                                    value={prodEnd} 
                                                    onChange={(e) => setProdEnd(e.target.value)} 
                                                    className="w-1/2 border rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-8">
                                {/* 1. ì›”ë³„ ì¶”ì´ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold flex items-center gap-2">
                                            <TrendingUp /> 1. ì›”ë³„ ì ‘ìˆ˜ ê±´ìˆ˜ ì¶”ì´ (Top 10 ì‚¬ìš©ìì¬)
                                        </h3>
                                        <button onClick={() => exportChartData(timeSeriesStacked.data, "ì›”ë³„ì¶”ì´.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={timeSeriesStacked.data}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="month" />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip />
                                                <Legend />
                                                {timeSeriesStacked.keys.map((key, index) => (
                                                    <Bar key={key} dataKey={key} stackId="a" fill={palette[index % palette.length]} />
                                                ))}
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 2. íŒŒë ˆí†  */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">2. ì‚¬ìš©ìì¬ë³„ íŒŒë ˆí†  ë¶„ì„</h3>
                                        <button onClick={() => exportChartData(materialRateCumulative.slice(0, 10), "íŒŒë ˆí† .xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full" style={{height: '468px'}}>
                                        <ResponsiveContainer>
                                            <ComposedChart data={materialRateCumulative.slice(0, 10)}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="name" angle={-30} textAnchor="end" height={80} interval={0} />
                                                <YAxis yAxisId="left" orientation="left" stroke={palette[0]} allowDecimals={false} />
                                                <YAxis yAxisId="right" orientation="right" stroke={palette[3]} domain={[0, 1]} tickFormatter={(v) => `${(v * 100).toFixed(0)}%`} />
                                                <Tooltip formatter={(value, name) => name === "cumulativeRatio" ? [`${(value * 100).toFixed(2)}%`, "ëˆ„ì ë¹„ìœ¨"] : [value, "ê±´ìˆ˜"]} />
                                                <Legend />
                                                <Bar yAxisId="left" dataKey="count" name="ê±´ìˆ˜" fill={palette[0]} />
                                                <Line yAxisId="right" type="monotone" dataKey="cumulativeRatio" name="ëˆ„ì ë¹„ìœ¨" stroke={palette[3]} strokeWidth={2} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 3. íˆíŠ¸ë§µ - ìƒì‚°ì›” x ì ‘ìˆ˜ì›” */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">3. ì½”í˜¸íŠ¸ ë¶„ì„ (ìƒì‚°ì›” Ã— ì ‘ìˆ˜ì›”)</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => {
                                                const cohortData = [];
                                                heatmapProdRecv.prodMonths.forEach(pm => {
                                                    const row = { ìƒì‚°ì›”: pm };
                                                    heatmapProdRecv.recvMonths.forEach(rm => {
                                                        row[rm] = heatmapProdRecv.matrix.get(`${pm}|${rm}`) || 0;
                                                    });
                                                    cohortData.push(row);
                                                });
                                                exportChartData(cohortData, "ì½”í˜¸íŠ¸ë¶„ì„.xlsx");
                                            }} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                                <Download /> ë‚´ë³´ë‚´ê¸°
                                            </button>
                                            <select value={heatmapSortOrder} onChange={(e) => setHeatmapSortOrder(e.target.value)} className="px-3 py-1 border rounded-lg text-sm">
                                                <option value="asc">ê³¼ê±° â†’ ìµœê·¼</option>
                                                <option value="desc">ìµœê·¼ â†’ ê³¼ê±°</option>
                                            </select>
                                            <select value={heatmapColorScheme} onChange={(e) => setHeatmapColorScheme(e.target.value)} className="px-3 py-1 border rounded-lg text-sm">
                                                <option value="blue">íŒŒë€ìƒ‰</option>
                                                <option value="red">ë¹¨ê°„ìƒ‰</option>
                                                <option value="green">ë…¹ìƒ‰</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="overflow-auto" style={{maxHeight: '768px'}}>
                                        <table className="w-full text-xs border-collapse heatmap-table">
                                            <thead>
                                                <tr>
                                                    <th className="sticky-header sticky-left p-2 border bg-gray-100 font-bold">ìƒì‚°ì›” \ ì ‘ìˆ˜ì›”</th>
                                                    {heatmapProdRecv.recvMonths.map((rm, idx) => (
                                                        <th 
                                                            key={rm} 
                                                            className={`sticky-header p-2 border bg-gray-100 font-semibold whitespace-nowrap ${hoveredCol === idx ? 'heatmap-col-hover' : ''}`}
                                                            onMouseEnter={() => setHoveredCol(idx)}
                                                            onMouseLeave={() => setHoveredCol(null)}
                                                        >
                                                            {rm}
                                                        </th>
                                                    ))}
                                                    <th className="sticky-header sticky-right p-2 border bg-gray-100 font-bold">í•©ê³„</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {heatmapProdRecv.prodMonths.map((pm, rowIdx) => {
                                                    let rowTotal = 0;
                                                    return (
                                                        <tr 
                                                            key={pm} 
                                                            className={`heatmap-row ${hoveredRow === rowIdx ? 'bg-blue-50' : ''}`}
                                                            onMouseEnter={() => setHoveredRow(rowIdx)}
                                                            onMouseLeave={() => setHoveredRow(null)}
                                                        >
                                                            <td className="sticky-left p-2 border bg-gray-50 font-semibold whitespace-nowrap">{pm}</td>
                                                            {heatmapProdRecv.recvMonths.map((rm, colIdx) => {
                                                                const val = heatmapProdRecv.matrix.get(`${pm}|${rm}`) || 0;
                                                                rowTotal += val;
                                                                return (
                                                                    <td
                                                                        key={rm}
                                                                        className={`heatmap-cell p-2 border text-center font-medium ${hoveredCol === colIdx ? 'heatmap-col-hover' : ''}`}
                                                                        style={{ backgroundColor: getHeatColor(val, heatmapProdRecv.maxValue, heatmapColorScheme) }}
                                                                        onClick={() => {
                                                                            if (val > 0) {
                                                                                const rows = filtered.filter(r => r.productionYM === pm && r.receiptYM === rm);
                                                                                openModal(`ìƒì‚°ì›” ${pm} â†’ ì ‘ìˆ˜ì›” ${rm} (${val}ê±´)`, rows);
                                                                            }
                                                                        }}
                                                                    >
                                                                        {val > 0 ? val : ''}
                                                                    </td>
                                                                );
                                                            })}
                                                            <td className="sticky-right p-2 border text-center font-bold bg-gray-50">{rowTotal}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* 4. íˆíŠ¸ë§µ - ìƒì‚°ì›” x ì‚¬ìš©ê¸°ê°„ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">4. ì‚¬ìš©ê¸°ê°„ ë¶„ì„ (ìƒì‚°ì›” Ã— ì‚¬ìš©ê¸°ê°„)</h3>
                                        <button onClick={() => {
                                            const usageData = [];
                                            heatmapProdUsage.prodMonths.forEach(pm => {
                                                const row = { ìƒì‚°ì›”: pm };
                                                heatmapProdUsage.usageBins.forEach(ub => {
                                                    row[`${ub}ê°œì›”`] = heatmapProdUsage.matrix.get(`${pm}|${ub}`) || 0;
                                                });
                                                usageData.push(row);
                                            });
                                            exportChartData(usageData, "ì‚¬ìš©ê¸°ê°„ë¶„ì„.xlsx");
                                        }} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="overflow-auto" style={{maxHeight: '768px'}}>
                                        <table className="w-full text-xs border-collapse heatmap-table">
                                            <thead>
                                                <tr>
                                                    <th className="sticky-header sticky-left p-2 border bg-gray-100 font-bold">ìƒì‚°ì›” \ ì‚¬ìš©ê¸°ê°„</th>
                                                    {heatmapProdUsage.usageBins.map((ub, idx) => (
                                                        <th 
                                                            key={ub} 
                                                            className={`sticky-header p-2 border bg-gray-100 font-semibold whitespace-nowrap ${hoveredCol === idx ? 'heatmap-col-hover' : ''}`}
                                                            onMouseEnter={() => setHoveredCol(idx)}
                                                            onMouseLeave={() => setHoveredCol(null)}
                                                        >
                                                            {ub}ê°œì›”
                                                        </th>
                                                    ))}
                                                    <th className="sticky-header sticky-right p-2 border bg-gray-100 font-bold">í•©ê³„</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {heatmapProdUsage.prodMonths.map((pm, rowIdx) => {
                                                    let rowTotal = 0;
                                                    return (
                                                        <tr 
                                                            key={pm}
                                                            className={`heatmap-row ${hoveredRow === rowIdx ? 'bg-blue-50' : ''}`}
                                                            onMouseEnter={() => setHoveredRow(rowIdx)}
                                                            onMouseLeave={() => setHoveredRow(null)}
                                                        >
                                                            <td className="sticky-left p-2 border bg-gray-50 font-semibold whitespace-nowrap">{pm}</td>
                                                            {heatmapProdUsage.usageBins.map((ub, colIdx) => {
                                                                const val = heatmapProdUsage.matrix.get(`${pm}|${ub}`) || 0;
                                                                rowTotal += val;
                                                                return (
                                                                    <td
                                                                        key={ub}
                                                                        className={`heatmap-cell p-2 border text-center font-medium ${hoveredCol === colIdx ? 'heatmap-col-hover' : ''}`}
                                                                        style={{ backgroundColor: getHeatColor(val, heatmapProdUsage.maxValue, heatmapColorScheme) }}
                                                                        onClick={() => {
                                                                            if (val > 0) {
                                                                                const rows = filtered.filter(r => {
                                                                                    const usage = diffMonths(r.productionYM, r.receiptYM);
                                                                                    return r.productionYM === pm && usage === ub;
                                                                                });
                                                                                openModal(`ìƒì‚°ì›” ${pm} / ì‚¬ìš©ê¸°ê°„ ${ub}ê°œì›” (${val}ê±´)`, rows);
                                                                            }
                                                                        }}
                                                                    >
                                                                        {val > 0 ? val : ''}
                                                                    </td>
                                                                );
                                                            })}
                                                            <td className="sticky-right p-2 border text-center font-bold bg-gray-50">{rowTotal}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* 5. MTBF */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">5. ëª¨ë¸ë³„ í‰ê·  ê³ ì¥ ê°„ê²© (MTBF - Top 10)</h3>
                                        <button onClick={() => exportChartData(mtbfData, "MTBF.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={mtbfData} layout="vertical">
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis type="number" label={{ value: 'MTBF (ê°œì›”)', position: 'bottom' }} />
                                                <YAxis type="category" dataKey="model" width={100} />
                                                <Tooltip />
                                                <Bar dataKey="mtbf" fill={palette[2]}>
                                                    {mtbfData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 6. ë ˆì´ë” ì°¨íŠ¸ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">6. Top 5 ëª¨ë¸ë³„ ì‚¬ìš©ìì¬ ë¶„í¬</h3>
                                        <button onClick={() => exportChartData(radarData, "ë ˆì´ë”.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-96">
                                        <ResponsiveContainer>
                                            <RadarChart data={radarData}>
                                                <PolarGrid />
                                                <PolarAngleAxis dataKey="defect" />
                                                <PolarRadiusAxis />
                                                <Tooltip />
                                                <Legend />
                                                {radarData.length > 0 && Object.keys(radarData[0]).filter(k => k !== 'defect').map((model, idx) => (
                                                    <Radar key={model} name={model} dataKey={model} stroke={palette[idx % palette.length]} fill={palette[idx % palette.length]} fillOpacity={0.3} />
                                                ))}
                                            </RadarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 7. ì—°ë„ë³„ ì¶”ì´ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">7. ì—°ë„ë³„ ì ‘ìˆ˜ ì¶”ì´</h3>
                                        <button onClick={() => exportChartData(yearlyTrend, "ì—°ë„ë³„ì¶”ì´.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <AreaChart data={yearlyTrend}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="year" />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip />
                                                <Legend />
                                                <Area type="monotone" dataKey="count" name="ì ‘ìˆ˜ ê±´ìˆ˜" fill={palette[5]} stroke={palette[5]} fillOpacity={0.6} />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 8. ì‚°ì ë„ (ì‚¬ìš©ê¸°ê°„ vs ë¶ˆëŸ‰) */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">8. ì‚¬ìš©ê¸°ê°„ ë¶„í¬ ì‚°ì ë„</h3>
                                        <button onClick={() => exportChartData(scatterData, "ì‚°ì ë„.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <ScatterChart>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis 
                                                    dataKey="x" 
                                                    name="ì‚¬ìš©ê¸°ê°„" 
                                                    label={{ value: 'ì‚¬ìš©ê¸°ê°„ (ê°œì›”)', position: 'bottom', offset: 0 }} 
                                                />
                                                <YAxis 
                                                    dataKey="y" 
                                                    name="ê±´ìˆ˜" 
                                                    label={{ value: 'ê±´ìˆ˜', angle: -90, position: 'insideLeft' }} 
                                                    allowDecimals={false}
                                                />
                                                <Tooltip 
                                                    cursor={{ strokeDasharray: '3 3' }}
                                                    formatter={(value, name) => {
                                                        if (name === 'x') return [value + 'ê°œì›”', 'ì‚¬ìš©ê¸°ê°„'];
                                                        if (name === 'y') return [value + 'ê±´', 'ê±´ìˆ˜'];
                                                        return [value, name];
                                                    }}
                                                />
                                                <Legend />
                                                <Scatter name="ë¶ˆëŸ‰ ë°œìƒ" data={scatterData} fill={palette[0]}>
                                                    {scatterData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Scatter>
                                            </ScatterChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 9. ë²„ë¸”ì°¨íŠ¸ (ëª¨ë¸ë³„ í˜„í™©) */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">9. ëª¨ë¸ë³„ í˜„í™© ë²„ë¸”ì°¨íŠ¸ (Top 20)</h3>
                                        <button onClick={() => exportChartData(bubbleData, "ë²„ë¸”ì°¨íŠ¸.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <ScatterChart>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis 
                                                    dataKey="x" 
                                                    name="í‰ê·  ì‚¬ìš©ê¸°ê°„" 
                                                    label={{ value: 'í‰ê·  ì‚¬ìš©ê¸°ê°„ (ê°œì›”)', position: 'bottom', offset: 0 }} 
                                                />
                                                <YAxis 
                                                    dataKey="y" 
                                                    name="ë¶ˆëŸ‰ ê±´ìˆ˜" 
                                                    label={{ value: 'ë¶ˆëŸ‰ ê±´ìˆ˜', angle: -90, position: 'insideLeft' }} 
                                                    allowDecimals={false}
                                                />
                                                <Tooltip 
                                                    cursor={{ strokeDasharray: '3 3' }}
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const data = payload[0].payload;
                                                            return (
                                                                <div className="bg-white p-3 border rounded shadow-lg">
                                                                    <p className="font-bold">{data.model}</p>
                                                                    <p className="text-sm">í‰ê·  ì‚¬ìš©ê¸°ê°„: {data.x.toFixed(1)}ê°œì›”</p>
                                                                    <p className="text-sm">ë¶ˆëŸ‰ ê±´ìˆ˜: {data.y}ê±´</p>
                                                                    <p className="text-sm text-red-600 font-bold">ë¹„ìœ¨: {data.ratio}%</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Scatter name="ëª¨ë¸" data={bubbleData} fill={palette[4]}>
                                                    {bubbleData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Scatter>
                                            </ScatterChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 10. íŠ¸ë¦¬ë§µ ëŒ€ì²´ - ëª¨ë¸-ì‚¬ìš©ìì¬ ë¶„í¬ (ë°” ì°¨íŠ¸) */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">10. ëª¨ë¸-ì‚¬ìš©ìì¬ ë¶„í¬ (Top 30)</h3>
                                        <button onClick={() => {
                                            const exportData = treemapData[0]?.children || [];
                                            exportChartData(exportData, "ëª¨ë¸ì‚¬ìš©ìì¬ë¶„í¬.xlsx");
                                        }} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-96">
                                        <ResponsiveContainer>
                                            <BarChart 
                                                data={treemapData[0]?.children.slice(0, 20) || []} 
                                                layout="horizontal"
                                                margin={{ top: 5, right: 30, left: 20, bottom: 100 }}
                                            >
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis 
                                                    dataKey="name" 
                                                    angle={-45} 
                                                    textAnchor="end" 
                                                    height={120}
                                                    interval={0}
                                                />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip 
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const data = payload[0].payload;
                                                            return (
                                                                <div className="bg-white p-3 border rounded shadow-lg">
                                                                    <p className="font-bold">{data.model}</p>
                                                                    <p className="text-sm">ì‚¬ìš©ìì¬: {data.defect}</p>
                                                                    <p className="text-sm text-red-600 font-bold">ê±´ìˆ˜: {data.size}ê±´</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Legend />
                                                <Bar dataKey="size" name="ë¶ˆëŸ‰ ê±´ìˆ˜" fill={palette[0]}>
                                                    {treemapData[0]?.children.slice(0, 20).map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 11. ë°•ìŠ¤í”Œë¡¯ (ì‚¬ìš©ê¸°ê°„ ë¶„í¬) */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">11. ì‚¬ìš©ê¸°ê°„ ë¶„í¬ ë°•ìŠ¤í”Œë¡¯</h3>
                                        <button onClick={() => boxPlotData && exportChartData(boxPlotData, "ë°•ìŠ¤í”Œë¡¯.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    {boxPlotData ? (
                                        <div className="w-full h-80">
                                            <div className="h-full flex items-center justify-center">
                                                <div className="w-full max-w-2xl">
                                                    <div className="relative h-64 border-l-2 border-b-2 border-gray-300 ml-16 mb-12">
                                                        {/* Yì¶• ë ˆì´ë¸” */}
                                                        <div className="absolute -left-12 top-0 bottom-0 flex items-center">
                                                            <span className="transform -rotate-90 text-sm text-gray-600">ì‚¬ìš©ê¸°ê°„ (ê°œì›”)</span>
                                                        </div>
                                                        
                                                        {/* ë°•ìŠ¤í”Œë¡¯ ì‹œê°í™” */}
                                                        <div className="absolute left-1/4 right-1/4 h-full flex flex-col justify-center">
                                                            {/* ìµœëŒ“ê°’ ì„  */}
                                                            <div className="relative h-full flex flex-col justify-between py-4">
                                                                <div className="text-center">
                                                                    <div className="h-px bg-gray-400 w-full mb-1"></div>
                                                                    <span className="text-xs font-bold text-gray-700">ìµœëŒ“ê°’: {boxPlotData[0].max}ê°œì›”</span>
                                                                </div>
                                                                
                                                                {/* ì¤‘ì•™ ë°•ìŠ¤ */}
                                                                <div className="relative bg-blue-200 border-2 border-blue-500 p-4">
                                                                    <div className="absolute top-0 left-0 right-0 text-center -mt-6">
                                                                        <span className="text-xs text-gray-600">Q3: {boxPlotData[0].q3}ê°œì›”</span>
                                                                    </div>
                                                                    <div className="h-px bg-red-500 w-full"></div>
                                                                    <div className="text-center">
                                                                        <span className="text-sm font-bold text-red-600">ì¤‘ì•™ê°’: {boxPlotData[0].median}ê°œì›”</span>
                                                                    </div>
                                                                    <div className="absolute bottom-0 left-0 right-0 text-center -mb-6">
                                                                        <span className="text-xs text-gray-600">Q1: {boxPlotData[0].q1}ê°œì›”</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="text-center">
                                                                    <div className="h-px bg-gray-400 w-full mt-1"></div>
                                                                    <span className="text-xs font-bold text-gray-700">ìµœì†Ÿê°’: {boxPlotData[0].min}ê°œì›”</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Xì¶• ë ˆì´ë¸” */}
                                                        <div className="absolute -bottom-8 left-0 right-0 text-center">
                                                            <span className="text-sm text-gray-600">í‰ê· : {boxPlotData[0].avg}ê°œì›”</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="w-full h-80 flex items-center justify-center text-gray-500">
                                            ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                                        </div>
                                    )}
                                </div>

                                {/* 12. ì˜ˆì¸¡ ë¶„ì„ (3ê°œì›” ì´ë™í‰ê· ) */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">12. ë¶ˆëŸ‰ë¥  ì¶”ì„¸ ì˜ˆì¸¡ (3ê°œì›” ì´ë™í‰ê· )</h3>
                                        <button onClick={() => exportChartData(forecastData, "ì˜ˆì¸¡ë¶„ì„.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <ComposedChart data={forecastData}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="month" angle={-30} textAnchor="end" height={80} />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip />
                                                <Legend />
                                                <Bar dataKey="actual" name="ì‹¤ì œ ê±´ìˆ˜" fill={palette[0]} fillOpacity={0.6} />
                                                <Line 
                                                    type="monotone" 
                                                    dataKey="ma3" 
                                                    name="3ê°œì›” ì´ë™í‰ê· " 
                                                    stroke={palette[3]} 
                                                    strokeWidth={3}
                                                    dot={{ fill: palette[3], r: 4 }}
                                                />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                    {forecastData.length > 0 && forecastData[forecastData.length - 1].forecast && (
                                        <div className="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                                            <p className="text-sm text-blue-800">
                                                <span className="font-bold">ğŸ“Š ì˜ˆì¸¡:</span> ë‹¤ìŒ ë‹¬ ({forecastData[forecastData.length - 1].month}) ì˜ˆìƒ ë¶ˆëŸ‰ ê±´ìˆ˜ëŠ” ì•½ <span className="font-bold text-lg text-blue-600">{forecastData[forecastData.length - 1].ma3}ê±´</span>ì…ë‹ˆë‹¤.
                                            </p>
                                        </div>
                                    )}
                                </div>

                                {/* 13. ëª¨ë¸ë³„/ì‚¬ìš©ìì¬ë³„ í…Œì´ë¸” */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                        <h3 className="text-xl font-bold mb-4">8. ëª¨ë¸ë³„ ë¶ˆëŸ‰ í˜„í™©</h3>
                                        <div className="overflow-auto max-h-96">
                                            <table className="w-full text-sm">
                                                <thead className="sticky-header bg-gray-50">
                                                    <tr>
                                                        <th className="p-2 text-left border font-semibold">ëª¨ë¸</th>
                                                        <th className="p-2 text-right border font-semibold">ê±´ìˆ˜</th>
                                                        <th className="p-2 text-right border font-semibold">ë¹„ìœ¨ (%)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(() => {
                                                        const modelCount = new Map();
                                                        const total = filtered.length || 1;
                                                        filtered.forEach(r => {
                                                            if (r.model !== "ì•Œìˆ˜ì—†ìŒ") {
                                                                modelCount.set(r.model, (modelCount.get(r.model) || 0) + 1);
                                                            }
                                                        });
                                                        return [...modelCount.entries()].sort((a, b) => b[1] - a[1]).slice(0, 15).map(([model, count], idx) => (
                                                            <tr key={idx} className="hover:bg-gray-50">
                                                                <td className="p-2 border">{model}</td>
                                                                <td className="p-2 text-right border font-medium">{count}</td>
                                                                <td className="p-2 text-right border">{((count / total) * 100).toFixed(2)}</td>
                                                            </tr>
                                                        ));
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                        <h3 className="text-xl font-bold mb-4">9. ì‚¬ìš©ìì¬ë³„ ë¶ˆëŸ‰ í˜„í™©</h3>
                                        <div className="overflow-auto max-h-96">
                                            <table className="w-full text-sm">
                                                <thead className="sticky-header bg-gray-50">
                                                    <tr>
                                                        <th className="p-2 text-left border font-semibold">ì‚¬ìš©ìì¬</th>
                                                        <th className="p-2 text-right border font-semibold">ê±´ìˆ˜</th>
                                                        <th className="p-2 text-right border font-semibold">ë¹„ìœ¨ (%)</th>
                                                        <th className="p-2 text-right border font-semibold">ëˆ„ì  (%)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {materialRateCumulative.slice(0, 15).map((r, idx) => (
                                                        <tr key={idx} className="hover:bg-gray-50">
                                                            <td className="p-2 border">{r.name}</td>
                                                            <td className="p-2 text-right border font-medium">{r.count}</td>
                                                            <td className="p-2 text-right border">{(r.ratio * 100).toFixed(2)}</td>
                                                            <td className="p-2 text-right border font-bold text-blue-600">{(r.cumulativeRatio * 100).toFixed(2)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                {/* 15. ë°”ì´ì˜¬ë¦° í”Œë¡¯ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">15. ì‚¬ìš©ê¸°ê°„ ë°€ë„ ë¶„í¬</h3>
                                        <button onClick={() => exportChartData(violinData, "ë°€ë„ë¶„í¬.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={violinData}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="range" angle={-30} textAnchor="end" height={80} />
                                                <YAxis allowDecimals={false} label={{ value: 'ê±´ìˆ˜', angle: -90, position: 'insideLeft' }} />
                                                <Tooltip />
                                                <Legend />
                                                <Bar dataKey="count" name="ë¶ˆëŸ‰ ê±´ìˆ˜" fill={palette[4]} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 16. ì›Œí„°í´ ì°¨íŠ¸ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">16. ì›”ë³„ ëˆ„ì  ì¶”ì´ (ì›Œí„°í´)</h3>
                                        <button onClick={() => exportChartData(waterfallData, "ì›Œí„°í´.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={waterfallData}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="month" angle={-30} textAnchor="end" height={80} />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip />
                                                <Legend />
                                                <Bar dataKey="count" name="ì¦ê°€ë¶„" fill={palette[2]} stackId="a" />
                                                <Bar dataKey="start" name="ê¸°ì¤€" fill="transparent" stackId="a" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 17. êµ¬ë¶„ë³„ ë¹„êµ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">17. êµ¬ë¶„ë³„ ë¹„êµ (ê³ ê°ìœ í˜•)</h3>
                                        <button onClick={() => exportChartData(categoryData, "êµ¬ë¶„ë³„ë¹„êµ.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={categoryData} layout="vertical">
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis type="number" />
                                                <YAxis type="category" dataKey="name" width={100} />
                                                <Tooltip 
                                                    formatter={(value, name) => {
                                                        if (name === 'count') return [value + 'ê±´', 'ê±´ìˆ˜'];
                                                        if (name === 'ratio') return [value + '%', 'ë¹„ìœ¨'];
                                                        return [value, name];
                                                    }}
                                                />
                                                <Legend />
                                                <Bar dataKey="count" name="ê±´ìˆ˜" fill={palette[6]}>
                                                    {categoryData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 18. í¼ë„ ì°¨íŠ¸ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">18. ì²˜ë¦¬ ë‹¨ê³„ë³„ í¼ë„</h3>
                                        <button onClick={() => exportChartData(funnelData, "í¼ë„.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <BarChart data={funnelData} layout="vertical">
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis type="number" />
                                                <YAxis type="category" dataKey="stage" width={100} />
                                                <Tooltip 
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const data = payload[0].payload;
                                                            return (
                                                                <div className="bg-white p-3 border rounded shadow-lg">
                                                                    <p className="font-bold">{data.stage}</p>
                                                                    <p className="text-sm">ê±´ìˆ˜: {data.count}</p>
                                                                    <p className="text-sm text-blue-600">ë¹„ìœ¨: {data.ratio}%</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Bar dataKey="count" name="ê±´ìˆ˜" fill={palette[7]}>
                                                    {funnelData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={palette[index % palette.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 19. ì „ë…„ë™ì›” ë¹„êµ */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">19. ì „ë…„ë™ì›” ë¹„êµ (ìµœê·¼ 12ê°œì›”)</h3>
                                        <button onClick={() => exportChartData(yoyCompare, "ì „ë…„ë™ì›”ë¹„êµ.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <ComposedChart data={yoyCompare}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="period" angle={-30} textAnchor="end" height={80} />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip 
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const data = payload[0].payload;
                                                            return (
                                                                <div className="bg-white p-3 border rounded shadow-lg">
                                                                    <p className="font-bold">{data.period}</p>
                                                                    <p className="text-sm">ê¸ˆë…„: {data.current}ê±´</p>
                                                                    <p className="text-sm">ì „ë…„: {data.previous}ê±´</p>
                                                                    {data.growth && (
                                                                        <p className={`text-sm font-bold ${parseFloat(data.growth) > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                                            ì¦ê°: {data.growth}%
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Legend />
                                                <Bar dataKey="current" name="ê¸ˆë…„" fill={palette[0]} />
                                                <Bar dataKey="previous" name="ì „ë…„" fill={palette[8]} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* 20. ì›”ë³„ ì„¸ë¶„í™” */}
                                <div className="rounded-2xl border bg-white shadow-md p-6 card-hover">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">20. ì›”ë³„ ì ‘ìˆ˜ ì¶”ì´ (ì—°ë„ë³„ ë¹„êµ)</h3>
                                        <button onClick={() => exportChartData(monthlyByYear, "ì›”ë³„ì—°ë„ë¹„êµ.xlsx")} className="px-3 py-1 rounded-lg border text-sm hover:bg-gray-50">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    <div className="w-full h-80">
                                        <ResponsiveContainer>
                                            <LineChart data={monthlyByYear}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="month" />
                                                <YAxis allowDecimals={false} />
                                                <Tooltip />
                                                <Legend />
                                                {monthlyByYear.length > 0 && Object.keys(monthlyByYear[0]).filter(k => k !== 'month').map((year, idx) => (
                                                    <Line 
                                                        key={year} 
                                                        type="monotone" 
                                                        dataKey={year} 
                                                        name={year} 
                                                        stroke={palette[idx % palette.length]} 
                                                        strokeWidth={2}
                                                        dot={{ r: 4 }}
                                                    />
                                                ))}
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {/* ëª¨ë‹¬ */}
                    {modalOpen && (
                        <div className="modal-overlay no-print" onClick={() => setModalOpen(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <header className="p-6 border-b flex items-center justify-between gradient-bg">
                                    <h2 className="text-2xl font-bold text-white">{modalTitle}</h2>
                                    <button onClick={() => setModalOpen(false)} className="p-2 rounded-full hover:bg-white/20 transition-colors">
                                        <XCircle />
                                    </button>
                                </header>
                                <div className="p-6 flex flex-col gap-4 overflow-auto flex-grow">
                                    <div className="flex items-center gap-3">
                                        <div className="relative flex-1">
                                            <input type="text" placeholder="ê²€ìƒ‰..." value={modalSearch} onChange={(e) => setModalSearch(e.target.value)} className="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <button onClick={() => setShowColPicker(!showColPicker)} className="px-4 py-2 rounded-xl border bg-gray-50 hover:bg-gray-100">
                                            ì»¬ëŸ¼ {showColPicker ? 'â–²' : 'â–¼'}
                                        </button>
                                        <button onClick={() => exportChartData(modalRows, "ìƒì„¸ë‚´ì—­.xlsx")} className="px-4 py-2 rounded-xl border bg-blue-50 hover:bg-blue-100">
                                            <Download /> ë‚´ë³´ë‚´ê¸°
                                        </button>
                                    </div>
                                    {showColPicker && (
                                        <div className="p-4 border rounded-xl bg-gray-50">
                                            <div className="font-semibold mb-2">í‘œì‹œ ì»¬ëŸ¼:</div>
                                            <div className="grid grid-cols-4 gap-2 text-xs">
                                                {Object.keys(modalCols).map((k) => (
                                                    <label key={k} className="flex items-center gap-1">
                                                        <input type="checkbox" checked={modalCols[k]} onChange={() => setModalCols(prev => ({ ...prev, [k]: !prev[k] }))} />
                                                        {k}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <div className="overflow-auto flex-grow">
                                        <table className="w-full text-xs border">
                                            <thead className="sticky top-0 bg-gray-100">
                                                <tr>
                                                    {Object.keys(modalCols).filter(k => modalCols[k]).map(k => (
                                                        <th key={k} className="p-2 border text-left font-semibold">{k}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {modalRows.filter(r => !modalSearch || JSON.stringify(r).toLowerCase().includes(modalSearch.toLowerCase())).map((row, idx) => (
                                                    <tr key={idx} className="hover:bg-blue-50">
                                                        {Object.keys(modalCols).filter(k => modalCols[k]).map(k => (
                                                            <td key={k} className="p-2 border">{String(row[k] ?? "")}</td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* í‘¸í„° */}
                    <footer className="mt-12 py-8 border-t no-print">
                        <div className="text-center text-gray-500 text-sm">
                            <p className="font-semibold mb-2">ğŸ“Š ë¶€ì í•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ V3.0 - ì™„ì „íŒ</p>
                            <p>Powered by React 16 + Recharts 1.8.5 + SheetJS + Tailwind CSS</p>
                            <p className="mt-2 text-xs">âœ¨ 20ê°œ ì°¨íŠ¸ | ğŸ¨ ì¸í„°ë™í‹°ë¸Œ íˆíŠ¸ë§µ | âš¡ ì‹¤ì‹œê°„ í•„í„°ë§ | ğŸ“¥ ê°œë³„ ë‚´ë³´ë‚´ê¸° | ğŸ”® ì˜ˆì¸¡ ë¶„ì„</p>
                        </div>
                        <div className="mt-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 text-xs">
                            {[
                                { name: "React", ver: "16", url: "https://unpkg.com/react@16", key: 'React' },
                                { name: "ReactDOM", ver: "16", url: "https://unpkg.com/react-dom@16", key: 'ReactDOM' },
                                { name: "XLSX", ver: "0.18.5", url: "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5", key: 'XLSX' },
                                { name: "Recharts", ver: "1.8.5", url: "https://cdn.jsdelivr.net/npm/recharts@1.8.5", key: 'Recharts' },
                                { name: "Babel", ver: "7.x", url: "https://unpkg.com/@babel/standalone", key: 'Babel' },
                                { name: "Tailwind", ver: "latest", url: "https://cdn.tailwindcss.com", key: 'Tailwind' },
                                { name: "PropTypes", ver: "15.7.2", url: "https://unpkg.com/prop-types@15.7.2", key: 'PropTypes' },
                            ].map(lib => (
                                <div key={lib.name} className="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                                    <div className="flex items-center mb-1">
                                        <span className={`library-status ${libraryStatus[lib.key] ? 'library-loaded' : 'library-error'}`}></span>
                                        <div className="font-semibold text-gray-800">{lib.name}</div>
                                    </div>
                                    <div className="text-gray-500">v{lib.ver}</div>
                                    <a href={lib.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CDN</a>
                                </div>
                            ))}
                        </div>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<DashboardV3 />, document.getElementById('root'));
    </script>
</body>
</html>